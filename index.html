<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fall Detection</title>
</head>
<body>
  <h1>Fall_Detection</h1>
  
  <h2>Accelerometer</h2>
  <p>X: <span id="accel-x">0</span></p>
  <p>Y: <span id="accel-y">0</span></p>
  <p>Z: <span id="accel-z">0</span></p>

  <p id="alert-message" style="color: red;">Status: Monitoring...</p>

  <button id="request-permission" onclick="requestPermission()">Enable Motion</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.1/firebase-database.js"></script>
  
  <script>
    console.log("Initializing Firebase");

    var firebaseConfig = {
      apiKey: "AIzaSyCjOfVeknGmtOr9LnRbSvmWNARMzoVV4hw",
      authDomain: "trial3-6e298.firebaseapp.com",
      databaseURL: "https://trial3-6e298-default-rtdb.firebaseio.com",
      projectId: "trial3-6e298",
      storageBucket: "trial3-6e298.firebaseapp.com",
      messagingSenderId: "665240996623",
      appId: "1:665240996623:web:9a09c622a4208d737b4c7a",
      measurementId: "G-JEL97GBLLV"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var database = firebase.database();

    // Threshold values for fall detection
    const FREE_FALL_THRESHOLD = 1;
    const IMPACT_THRESHOLD = -10;

    let inFreeFall = false;
    let fallDetected = false;

    // Function to send fall detection status to Firebase
    function sendFallStatusToFirebase(status) {
      database.ref("fallDetection").set({
        fall_detected: status ? 1 : 0
      });
      document.getElementById("alert-message").textContent = status ? "Fall detected!" : "Status: Monitoring...";
    }

    // Request permission (necessary for iOS devices)
    function requestPermission() {
      if (typeof DeviceMotionEvent.requestPermission === "function") {
        DeviceMotionEvent.requestPermission()
          .then(response => {
            if (response === "granted") {
              startMotionTracking();
              document.getElementById("request-permission").style.display = "none";
            } else {
              alert("Permission denied");
            }
          })
          .catch(console.error);
      } else {
        startMotionTracking();
        document.getElementById("request-permission").style.display = "none";
      }
    }

    // Function to start tracking accelerometer data
    function startMotionTracking() {
      if (window.DeviceMotionEvent) {
        window.addEventListener("devicemotion", (event) => {
          const accel = event.accelerationIncludingGravity;

          // Display accelerometer values
          document.getElementById("accel-x").textContent = accel.x?.toFixed(2) || "0";
          document.getElementById("accel-y").textContent = accel.y?.toFixed(2) || "0";
          document.getElementById("accel-z").textContent = accel.z?.toFixed(2) || "0";

          // Calculate total acceleration
          const totalAcceleration = Math.sqrt(accel.x ** 2 + accel.y ** 2 + accel.z ** 2);

          // Detect free fall
          if (totalAcceleration < FREE_FALL_THRESHOLD) {
            inFreeFall = true;
          } else if (inFreeFall && totalAcceleration > IMPACT_THRESHOLD) {
            // Detect impact after free fall
            inFreeFall = false;
            fallDetected = true;
            sendFallStatusToFirebase(true); // Send fall detected to Firebase
          } else {
            // No fall detected
            fallDetected = false;
            sendFallStatusToFirebase(false); // Reset fall detected in Firebase
          }
        });
      } else {
        alert("DeviceMotion is not supported on this device.");
      }
    }
  </script>
</body>
</html>
