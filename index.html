<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Fall Detection with Flip Detection</title>
</head>
<body>
  <h1>Fall Detection with Flip Detection</h1>
  
  <h2>Accelerometer</h2>
  <p>X: <span id="accel-x">0</span></p>
  <p>Y: <span id="accel-y">0</span></p>
  <p>Z: <span id="accel-z">0</span></p>

  <h2>Gyroscope</h2>
  <p>Alpha (Z-axis rotation): <span id="gyro-alpha">0</span></p>
  <p>Beta (X-axis rotation): <span id="gyro-beta">0</span></p>
  <p>Gamma (Y-axis rotation): <span id="gyro-gamma">0</span></p>

  <p id="alert-message" style="color: red;">Status: Monitoring...</p>

  <button id="request-permission" style="display: none;">Enable Motion</button>

  <script>
    const FREE_FALL_THRESHOLD = 1;  // Near zero acceleration in m/s²
    const ROTATION_THRESHOLD = 3;   // Rotation rate threshold in rad/s
    const IMPACT_THRESHOLD = 20;    // Impact spike in m/s²

    let inFreeFall = false;
    let dropDetected = false;

    // Request permission for iOS devices
    function requestPermission() {
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        DeviceMotionEvent.requestPermission()
          .then((response) => {
            if (response === 'granted') {
              startMotionTracking();
            } else {
              alert('Permission denied');
            }
          })
          .catch(console.error);
      } else {
        startMotionTracking();
      }
    }

    function startMotionTracking() {
      if (window.DeviceMotionEvent) {
        window.addEventListener('devicemotion', (event) => {
          const accel = event.accelerationIncludingGravity;
          const x = accel.x || 0;
          const y = accel.y || 0;
          const z = accel.z || 0;

          // Calculate total acceleration magnitude
          const totalAccel = Math.sqrt(x * x + y * y + z * z);

          // Display accelerometer values
          document.getElementById('accel-x').textContent = x.toFixed(2);
          document.getElementById('accel-y').textContent = y.toFixed(2);
          document.getElementById('accel-z').textContent = z.toFixed(2);

          // Check for free fall (near-zero total acceleration)
          if (totalAccel < FREE_FALL_THRESHOLD) {
            inFreeFall = true;
            document.getElementById('alert-message').textContent = 'Status: Free fall detected!';
          } else if (inFreeFall && totalAccel > IMPACT_THRESHOLD) {
            // If previously in free fall and now there's a spike in acceleration, assume impact
            dropDetected = true;
            document.getElementById('alert-message').textContent = 'Alert: Fall detected!';
            alert("Fall detected!");
            inFreeFall = false;  // Reset free fall status
          } else {
            // Reset if no significant event
            inFreeFall = false;
          }
        });
      }

      // Gyroscope event listener for rotation detection
      if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', (event) => {
          const alpha = event.alpha || 0;
          const beta = event.beta || 0;
          const gamma = event.gamma || 0;

          // Display gyroscope values
          document.getElementById('gyro-alpha').textContent = alpha.toFixed(2);
          document.getElementById('gyro-beta').textContent = beta.toFixed(2);
          document.getElementById('gyro-gamma').textContent = gamma.toFixed(2);

          // Check for high rotation rate (flipping detection)
          if (Math.abs(alpha) > ROTATION_THRESHOLD ||
              Math.abs(beta) > ROTATION_THRESHOLD ||
              Math.abs(gamma) > ROTATION_THRESHOLD) {
            document.getElementById('alert-message').textContent = 'Status: Flipping detected!';
          }
        });
      }
    }

    // Show the button on iOS
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      document.getElementById('request-permission').style.display = 'block';
      document.getElementById('request-permission').onclick = requestPermission;
    } else {
      startMotionTracking();
    }
  </script>
</body>
</html>
